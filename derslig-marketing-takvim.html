<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Derslig 2025-26 Pazarlama Takvimi (Haftalık Görünüm)</title>
  <script src="https://cdn.tailwindcss.com" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body class="p-4 bg-gray-100 font-inter">
  <div class="max-w-full mx-auto bg-white rounded-xl shadow-lg p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-gray-800">Derslig 2025-26 Pazarlama Takvimi (Haftalık Görünüm)</h1>
      <p class="mt-1 text-gray-600">Her ay 4 haftadan oluşan zaman çizelgesi.</p>
      <div class="mt-4 flex flex-wrap gap-2 items-center">
        <span class="font-semibold text-gray-700 mr-2">Filtrele:</span>
        <div id="persona-filters" class="flex gap-2">
          <button data-filter="all" class="filter-btn active px-3 py-1 text-sm bg-blue-500 text-white rounded-full">Tümü</button>
          <button data-filter="veli" class="filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-full">Veli</button>
          <button data-filter="ogrenci" class="filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-full">Öğrenci</button>
          <button data-filter="ogretmen" class="filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-full">Öğretmen</button>
          <button data-filter="kurum" class="filter-btn px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-full">Kurum</button>
        </div>
      </div>
    </header>

    <div class="overflow-x-auto border rounded-lg">
      <table class="min-w-max border-collapse">
        <thead class="bg-white sticky top-0">
          <tr id="header-month"></tr>
          <tr id="header-week"></tr>
        </thead>
        <tbody id="schedule-body">
          <tr><td colspan="100" class="p-4 text-center text-gray-500">Veriler yükleniyor...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTYD8dUx1q5XYhUTJ_D9ZAzyBX_oQZqsyM3N41HPBNwq9TwEtW5s2x9W5_fBRqnFFI2TpckMFL3qQkE/pub?gid=0&single=true&output=csv';
      const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(sheetUrl);
      const months = ['Ağustos','Eylül','Ekim','Kasım','Aralık','Ocak','Şubat','Mart','Nisan','Mayıs','Haziran','Temmuz'];
      const weeksPerMonth = 4;
      const totalWeeks = months.length * weeksPerMonth;
      const thMonth = document.getElementById('header-month');
      const thWeek = document.getElementById('header-week');
      const tbody = document.getElementById('schedule-body');
      const filtersEl = document.getElementById('persona-filters');
      let records = [];

      // Build headers
      const thInit = document.createElement('th');
      thInit.textContent = 'Pazarlama Hamlesi';
      thInit.rowSpan = 2;
      thInit.className = 'p-2 border text-left';
      thMonth.appendChild(thInit);
      months.forEach(m => {
        const th = document.createElement('th');
        th.textContent = m;
        th.colSpan = weeksPerMonth;
        th.className = 'p-2 border text-center';
        thMonth.appendChild(th);
      });
      for(let i=0;i<months.length;i++){
        for(let w=1;w<=weeksPerMonth;w++){
          const th = document.createElement('th');
          th.textContent = w + '. Hafta';
          th.className = 'p-2 border text-center';
          thWeek.appendChild(th);
        }
      }

      // Fetch and parse CSV
      fetch(proxy)
        .then(res => res.ok ? res.text() : Promise.reject(new Error(res.statusText)))
        .then(csvText => {
          const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
          records = parsed.data.map(item => {
            let mIdx = parseInt(item.startMonth,10);
            if(isNaN(mIdx) || mIdx < 0 || mIdx >= months.length) mIdx = months.indexOf(item.startMonth);
            return {
              initiative: item.initiative,
              color: item.color || 'bg-gray-400',
              personas: item.personas ? item.personas.split(',').map(p => p.trim()) : [],
              monthIdx: mIdx,
              startWeek: Number(item.startWeek),
              duration: Number(item.duration)
            };
          });
          render('all');
        })
        .catch(err => {
          tbody.innerHTML = `<tr><td colspan="${totalWeeks+1}" class="p-4 text-center text-red-500">CSV yüklenirken hata: ${err.message}</td></tr>`;
          console.error('CSV Error:', err);
        });

      function render(filter){
        tbody.innerHTML = '';
        records.filter(r=>filter==='all'||r.personas.includes(filter)).forEach(r=>{
          const tr=document.createElement('tr');
          // Initiative
          const tdInit=document.createElement('td');
          tdInit.className='p-2 border';
          tdInit.innerHTML=`<div class=\
